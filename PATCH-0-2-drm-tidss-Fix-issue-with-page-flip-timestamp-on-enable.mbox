From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from perceval.ideasonboard.com (perceval.ideasonboard.com [213.167.242.64])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id EB19535E4CA
	for <linux-kernel@vger.kernel.org>; Fri,  5 Sep 2025 13:59:01 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=213.167.242.64
ARC-Seal:i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1757080744; cv=none; b=Jf8r8SOYpsLxfVViAqiRhvNnVXPmpj+3R1NIEVDyjEw8OegRm8cXqSf94Czpr76abuIZt2qelU4AHAL2sB7kCjbulzSbrDRzotgBoqp1Eylu4rHy+kMsXL141/gR5SXiLHPiweX/rdDghoOgy/IdieWFgnaLXQWOEkycUPOrv0A=
ARC-Message-Signature:i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1757080744; c=relaxed/simple;
	bh=9LxxYhOkJgXUvxE2ZO4TrHjls5tQc2g6KQ5jlrd2xUk=;
	h=From:Subject:Date:Message-Id:MIME-Version:Content-Type:To:Cc; b=ZKCciyp13I3BHuDHyxCrh1PwQSFBm2v4Dps4TVi6QfnWnZHbKp7zUjmno3jwgA8R6luASrItb+3ey+pzVzoGhwO8vuARVvx6nd9uwcS2eEVdFoHqKBQMwOzKUyiF1ziT9iLF/ulnQ+xfNLKXBUifCd+m7fDGsNImFu4KgOb19sA=
ARC-Authentication-Results:i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=ideasonboard.com; spf=pass smtp.mailfrom=ideasonboard.com; dkim=pass (1024-bit key) header.d=ideasonboard.com header.i=@ideasonboard.com header.b=GgIuW4Bu; arc=none smtp.client-ip=213.167.242.64
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=ideasonboard.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=ideasonboard.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=ideasonboard.com header.i=@ideasonboard.com header.b="GgIuW4Bu"
Received: from [127.0.1.1] (91-158-153-178.elisa-laajakaista.fi [91.158.153.178])
	by perceval.ideasonboard.com (Postfix) with ESMTPSA id 9BF1EF09;
	Fri,  5 Sep 2025 15:57:48 +0200 (CEST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=ideasonboard.com;
	s=mail; t=1757080669;
	bh=9LxxYhOkJgXUvxE2ZO4TrHjls5tQc2g6KQ5jlrd2xUk=;
	h=From:Subject:Date:To:Cc:From;
	b=GgIuW4BuEzKLQei3pMC5Edx34buE2i/iqREHUH695VXOYk7qFYxun52nPYwLbjOpW
	 G/a7Su4cVbVecaQTzqvZvlSFnxlWikxrWzysuBNnWSkHt94VYhkCBC0oHSiK/4cAi4
	 vf7BQtD3YpR0bSV00mEQzMClmG5ZPPl8HjzKXk+k=
From: Tomi Valkeinen <tomi.valkeinen@ideasonboard.com>
Subject: [PATCH 0/2] drm/tidss: Fix issue with page flip timestamp on
 enable
Date: Fri, 05 Sep 2025 16:58:05 +0300
Message-Id: <20250905-tidss-fix-timestamp-v1-0-c2aedf31e2c9@ideasonboard.com>
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: 7bit
X-B4-Tracking: v=1; b=H4sIAG3sumgC/x2MSwqAMAwFryJZW4hVQb2KuChtqln4oSkiFO9uc
 DcD814BocQkMFUFEt0sfB4qTV2B39yxkuGgDhZtjyP2JnMQMZEfpZ0ku/0ysUMfBkuhxRF0eSX
 S4H+dl/f9AOCPdQ5lAAAA
X-Change-ID: 20250905-tidss-fix-timestamp-f40cd82ed309
To: Jyri Sarha <jyri.sarha@iki.fi>, 
 Maarten Lankhorst <maarten.lankhorst@linux.intel.com>, 
 Maxime Ripard <mripard@kernel.org>, Thomas Zimmermann <tzimmermann@suse.de>, 
 David Airlie <airlied@gmail.com>, Simona Vetter <simona@ffwll.ch>
Cc: Pekka Paalanen <pekka.paalanen@collabora.com>, 
 dri-devel@lists.freedesktop.org, linux-kernel@vger.kernel.org, 
 Laurent Pinchart <laurent.pinchart@ideasonboard.com>, 
 Tomi Valkeinen <tomi.valkeinen@ideasonboard.com>
X-Mailer: b4 0.15-dev-c25d1
X-Developer-Signature: v=1; a=openpgp-sha256; l=765;
 i=tomi.valkeinen@ideasonboard.com; h=from:subject:message-id;
 bh=9LxxYhOkJgXUvxE2ZO4TrHjls5tQc2g6KQ5jlrd2xUk=;
 b=owEBbQKS/ZANAwAIAfo9qoy8lh71AcsmYgBouuyeFWGVBsF4GOdkJTxKgD7opR6+5vfxTy+uG
 C6aG1GFol6JAjMEAAEIAB0WIQTEOAw+ll79gQef86f6PaqMvJYe9QUCaLrsngAKCRD6PaqMvJYe
 9SU2D/9RRtZ9XeXYOrDFhK5MPJ7Cdkpu0mMwNz9DaqP90uKts0AmesMe+OFZGFqN9XEj+8ACS4z
 48rqeQSi9n5q0TcLC59NLYsQXhwKkJiblKJ1HbuuSp0JEa1wQ3imkTScuqh0l43Evhl//G3Gs6D
 CXT1HuOo4OpjI0bx8zVN0zF1c/uGuLIMeGIftkg3tqPpx/YMkeDRd9NwxQWFzgSKwq/+EVuyelP
 tcUB98etNUCvSlrqMDWjGksiPSLEz6A6H8N+LLoPg/NiXAet0OCPWHjtCDVXvNL/nfuzfo5gLnY
 H2H1ThU3Vi3rwYCaxIKA/INlHwT8jC6H8x1BGTsrJkQICNEM0bSvYLCkDEqnN4OxI94Nrm/6VXx
 4zZocSDyLL3NbHqI7ZGBvZ7OIOgK1ZHFaS14emUhXr2k8YrXNqCUDrwYc3eZ5qXVAu1EuimwfBO
 MROs568TEkrWJaWvfIOtnfJu2pCMypR3R+rrg070LF9GLgXRj/B1yl0VZTBHob34H4FXjsBJspE
 cwnvT4mgrp3lPmNEXvAMvOhb3qOCDLmQSlVQ+2ry0thr39zqDT4rk+3p1/uera2arQ8TNpTaFhM
 8+mDAxd+zQ2R4HrjRbMtyp3BKqxOjoD7Tjr7FElz+edzd4kft4vAVBp9QjTRs9PWT2FYO9l9r8W
 CkNdnbSxVg1MszQ==
X-Developer-Key: i=tomi.valkeinen@ideasonboard.com; a=openpgp;
 fpr=C4380C3E965EFD81079FF3A7FA3DAA8CBC961EF5

This fixes an issue with the page flip timestamp being 0 on CRTC enable.
See the second patch for in depth explanation

 Tomi

Signed-off-by: Tomi Valkeinen <tomi.valkeinen@ideasonboard.com>
---
Tomi Valkeinen (2):
      drm/tidss: Restructure dispc_vp_prepare() and dispc_vp_enable()
      drm/tidss: Set vblank (event) time at crtc_atomic_enable

 drivers/gpu/drm/tidss/tidss_crtc.c  |  9 +++++++--
 drivers/gpu/drm/tidss/tidss_dispc.c | 22 ++++++----------------
 drivers/gpu/drm/tidss/tidss_dispc.h |  3 +--
 3 files changed, 14 insertions(+), 20 deletions(-)
---
base-commit: 03e7ae93c6e32206797c13118659a966ae84a3bb
change-id: 20250905-tidss-fix-timestamp-f40cd82ed309

Best regards,
-- 
Tomi Valkeinen <tomi.valkeinen@ideasonboard.com>


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from perceval.ideasonboard.com (perceval.ideasonboard.com [213.167.242.64])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id ED58335E4CB
	for <linux-kernel@vger.kernel.org>; Fri,  5 Sep 2025 13:59:02 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=213.167.242.64
ARC-Seal:i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1757080745; cv=none; b=nSyIa5uv5IR6rkehXt+wGNaBC1AYWDnJff9VVG0nHkpu/tyoRiaKAftu9rQSL+U0OEds2q7q/RVyRCTB7JBc1Icx8p2U48XWPkZlWESVs6C8LCKETP8WLsx4KuVfKR1XAdC/s2eXxk9hUbySUu1Shlfx1Rc2j4sQiJjURo7ik+E=
ARC-Message-Signature:i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1757080745; c=relaxed/simple;
	bh=Q6Wf1vTZSaIlKJqbaA1DqzvL+IqhH2Z176IYQMLiPD4=;
	h=From:Date:Subject:MIME-Version:Content-Type:Message-Id:References:
	 In-Reply-To:To:Cc; b=FRurejXyq4X+7qgjFK1M0yLOqu+eBE6YUx+hrNLZtmaSjud1G9hBWesrZ0Ih8062JfmoSrBMKXeQSHT5GdmgwVFK5FgygNpUUCmRKCFBjFa3LAAS+FxHfem4I6HIO+ToxZHYJH0C35WyeqITrf7n187cSMAUx5LoWyCh4pm+R3A=
ARC-Authentication-Results:i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=ideasonboard.com; spf=pass smtp.mailfrom=ideasonboard.com; dkim=pass (1024-bit key) header.d=ideasonboard.com header.i=@ideasonboard.com header.b=P+auLbKc; arc=none smtp.client-ip=213.167.242.64
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=ideasonboard.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=ideasonboard.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=ideasonboard.com header.i=@ideasonboard.com header.b="P+auLbKc"
Received: from [127.0.1.1] (91-158-153-178.elisa-laajakaista.fi [91.158.153.178])
	by perceval.ideasonboard.com (Postfix) with ESMTPSA id 551BF1121;
	Fri,  5 Sep 2025 15:57:49 +0200 (CEST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=ideasonboard.com;
	s=mail; t=1757080669;
	bh=Q6Wf1vTZSaIlKJqbaA1DqzvL+IqhH2Z176IYQMLiPD4=;
	h=From:Date:Subject:References:In-Reply-To:To:Cc:From;
	b=P+auLbKcOvvDHIT23THo9Tnpfag9ob2f5r+RzND93z+9MB3O1i01vbSWPF1DRvyhl
	 wt9JhRgFZddytSYPUAO4D9l/49dcH/6h6QVpWtR88TIX68TZFohRzFUsSdVtfvG+RU
	 bd2gplQ/032RheRQI0T0TcFj1Fwn+VnTTNMNqZcg=
From: Tomi Valkeinen <tomi.valkeinen@ideasonboard.com>
Date: Fri, 05 Sep 2025 16:58:06 +0300
Subject: [PATCH 1/2] drm/tidss: Restructure dispc_vp_prepare() and
 dispc_vp_enable()
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: 7bit
Message-Id: <20250905-tidss-fix-timestamp-v1-1-c2aedf31e2c9@ideasonboard.com>
References: <20250905-tidss-fix-timestamp-v1-0-c2aedf31e2c9@ideasonboard.com>
In-Reply-To: <20250905-tidss-fix-timestamp-v1-0-c2aedf31e2c9@ideasonboard.com>
To: Jyri Sarha <jyri.sarha@iki.fi>, 
 Maarten Lankhorst <maarten.lankhorst@linux.intel.com>, 
 Maxime Ripard <mripard@kernel.org>, Thomas Zimmermann <tzimmermann@suse.de>, 
 David Airlie <airlied@gmail.com>, Simona Vetter <simona@ffwll.ch>
Cc: Pekka Paalanen <pekka.paalanen@collabora.com>, 
 dri-devel@lists.freedesktop.org, linux-kernel@vger.kernel.org, 
 Laurent Pinchart <laurent.pinchart@ideasonboard.com>, 
 Tomi Valkeinen <tomi.valkeinen@ideasonboard.com>
X-Mailer: b4 0.15-dev-c25d1
X-Developer-Signature: v=1; a=openpgp-sha256; l=4459;
 i=tomi.valkeinen@ideasonboard.com; h=from:subject:message-id;
 bh=Q6Wf1vTZSaIlKJqbaA1DqzvL+IqhH2Z176IYQMLiPD4=;
 b=owEBbQKS/ZANAwAIAfo9qoy8lh71AcsmYgBouuyhQcJxaaJ7DbOUzaH2W8v0RIwP4qbKrh0dO
 RkDCB+xNjWJAjMEAAEIAB0WIQTEOAw+ll79gQef86f6PaqMvJYe9QUCaLrsoQAKCRD6PaqMvJYe
 9SRLEACwnIDQboTmlgeQ0zMAOvHmlaz2nZ3kQ6K9Hw8mhAwUfMI2tw4cQLrOTjAOcYwUrzd4Rhb
 pKAuY9qtUhO8aqLhOqxBPB379m2IIaO0a/sYSkqAeSVX5Zf0hNkRZAXf6JYZ6Hz63JNByLO6j42
 SleOae15J/rv0B9Cgu8BbE5+4P7NMCqU5IvUG7JsPbSnnnjE4bvTkavwRD+MhvLN16tLw6sRQKY
 cRmjmeyZLWJEgkb2JI6JStv3uRwQxOi9aiFYOyIFc3KVY3XjRllCqPtEVrOaozBk04ikKCdssFL
 msRJsHnG563dx+lx5CQpykjIvqhULy/3WYxcEG5IJUjE1nRVdEznDFvYL9EBrwkXRB4pI3+Rthw
 ZQfFpqrVG6OEKyV4RPkabhS0WgPJ8Rv8NVM33IlvVUMQvFC3FaTnAyP8BHyg8CFrAl7I/etTQ37
 giH4rTPX5jTsYBUuTQo5pPxQ+ZXeqnXA8VbblF9+pU3CX7lOSvKdw/AjSTpJDrlQvLNn8v/l9/V
 OxpRxJCR+X5sLeht9i8p/0jGiXWkMW79W9txAAFviNLdhy8WLBj6KipS6oLAgYlhjK2FN4Kdu1T
 2o5F+6jCUr1oPCmcR95QIQb1wRKtBRl/7apw4A4ygtC5A4+gnsyVo8ELovRz/nNQ/vlTCdhjiLi
 N+5wxF6IJlNYxiw==
X-Developer-Key: i=tomi.valkeinen@ideasonboard.com; a=openpgp;
 fpr=C4380C3E965EFD81079FF3A7FA3DAA8CBC961EF5

tidss_crtc.c calls dispc_vp_prepare() and dispc_vp_enable() in that
order, next to each other. dispc_vp_prepare() does preparations for
enabling the crtc, by writing some registers, and dispc_vp_enable() does
more preparations. As the last thing, dispc_vp_enable() enables the CRTC
by writing the enable bit.

There might have been a reason at some point in the history for this
split, but I can't find any point to it. They also do a bit of
overlapping work: both call dispc_vp_find_bus_fmt(). They could as well
be a single function.

But instead of combining them, this patch moves everything from
dispc_vp_enable() to dispc_vp_prepare(), except the actual CRTC enable
bit write. The reason for this is that unlike all the preparatory
register writes, CRTC enable has an immediate effect, starting the
timing generator and the CRTC as a whole. Thus it may be important to
time the enable just right (as we do in the next patch).

No functional changes.

Signed-off-by: Tomi Valkeinen <tomi.valkeinen@ideasonboard.com>
---
 drivers/gpu/drm/tidss/tidss_crtc.c  |  2 +-
 drivers/gpu/drm/tidss/tidss_dispc.c | 22 ++++++----------------
 drivers/gpu/drm/tidss/tidss_dispc.h |  3 +--
 3 files changed, 8 insertions(+), 19 deletions(-)

diff --git a/drivers/gpu/drm/tidss/tidss_crtc.c b/drivers/gpu/drm/tidss/tidss_crtc.c
index da89fd01c337..1b767af8e1f6 100644
--- a/drivers/gpu/drm/tidss/tidss_crtc.c
+++ b/drivers/gpu/drm/tidss/tidss_crtc.c
@@ -244,7 +244,7 @@ static void tidss_crtc_atomic_enable(struct drm_crtc *crtc,
 
 	dispc_vp_prepare(tidss->dispc, tcrtc->hw_videoport, crtc->state);
 
-	dispc_vp_enable(tidss->dispc, tcrtc->hw_videoport, crtc->state);
+	dispc_vp_enable(tidss->dispc, tcrtc->hw_videoport);
 
 	spin_lock_irqsave(&ddev->event_lock, flags);
 
diff --git a/drivers/gpu/drm/tidss/tidss_dispc.c b/drivers/gpu/drm/tidss/tidss_dispc.c
index 7c8c15a5c39b..d4762410d262 100644
--- a/drivers/gpu/drm/tidss/tidss_dispc.c
+++ b/drivers/gpu/drm/tidss/tidss_dispc.c
@@ -1161,6 +1161,9 @@ void dispc_vp_prepare(struct dispc_device *dispc, u32 hw_videoport,
 {
 	const struct tidss_crtc_state *tstate = to_tidss_crtc_state(state);
 	const struct dispc_bus_format *fmt;
+	const struct drm_display_mode *mode = &state->adjusted_mode;
+	bool align, onoff, rf, ieo, ipc, ihs, ivs;
+	u32 hsw, hfp, hbp, vsw, vfp, vbp;
 
 	fmt = dispc_vp_find_bus_fmt(dispc, hw_videoport, tstate->bus_format,
 				    tstate->bus_flags);
@@ -1173,22 +1176,6 @@ void dispc_vp_prepare(struct dispc_device *dispc, u32 hw_videoport,
 
 		dispc_enable_am65x_oldi(dispc, hw_videoport, fmt);
 	}
-}
-
-void dispc_vp_enable(struct dispc_device *dispc, u32 hw_videoport,
-		     const struct drm_crtc_state *state)
-{
-	const struct drm_display_mode *mode = &state->adjusted_mode;
-	const struct tidss_crtc_state *tstate = to_tidss_crtc_state(state);
-	bool align, onoff, rf, ieo, ipc, ihs, ivs;
-	const struct dispc_bus_format *fmt;
-	u32 hsw, hfp, hbp, vsw, vfp, vbp;
-
-	fmt = dispc_vp_find_bus_fmt(dispc, hw_videoport, tstate->bus_format,
-				    tstate->bus_flags);
-
-	if (WARN_ON(!fmt))
-		return;
 
 	dispc_set_num_datalines(dispc, hw_videoport, fmt->data_width);
 
@@ -1244,7 +1231,10 @@ void dispc_vp_enable(struct dispc_device *dispc, u32 hw_videoport,
 				  mode->crtc_hdisplay - 1) |
 		       FIELD_PREP(DISPC_VP_SIZE_SCREEN_VDISPLAY_MASK,
 				  mode->crtc_vdisplay - 1));
+}
 
+void dispc_vp_enable(struct dispc_device *dispc, u32 hw_videoport)
+{
 	VP_REG_FLD_MOD(dispc, hw_videoport, DISPC_VP_CONTROL, 1,
 		       DISPC_VP_CONTROL_ENABLE_MASK);
 }
diff --git a/drivers/gpu/drm/tidss/tidss_dispc.h b/drivers/gpu/drm/tidss/tidss_dispc.h
index 60c1b400eb89..f38493a70122 100644
--- a/drivers/gpu/drm/tidss/tidss_dispc.h
+++ b/drivers/gpu/drm/tidss/tidss_dispc.h
@@ -119,8 +119,7 @@ void dispc_ovr_enable_layer(struct dispc_device *dispc,
 
 void dispc_vp_prepare(struct dispc_device *dispc, u32 hw_videoport,
 		      const struct drm_crtc_state *state);
-void dispc_vp_enable(struct dispc_device *dispc, u32 hw_videoport,
-		     const struct drm_crtc_state *state);
+void dispc_vp_enable(struct dispc_device *dispc, u32 hw_videoport);
 void dispc_vp_disable(struct dispc_device *dispc, u32 hw_videoport);
 void dispc_vp_unprepare(struct dispc_device *dispc, u32 hw_videoport);
 bool dispc_vp_go_busy(struct dispc_device *dispc, u32 hw_videoport);

-- 
2.43.0


From mboxrd@z Thu Jan  1 00:00:00 1970
Received: from perceval.ideasonboard.com (perceval.ideasonboard.com [213.167.242.64])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 9C36E35E4EF
	for <linux-kernel@vger.kernel.org>; Fri,  5 Sep 2025 13:59:05 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=213.167.242.64
ARC-Seal:i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1757080747; cv=none; b=qAQcKOXP6kDCmz1QD2BxS8VdmPvwpEs5QvXPEqs7+ibOFYF3nHAcPH3z7Dy5e0QzDLxTw3xXA9yhZp+5zhpgY8qL/WkcX/7Gp3lU5fhHQUpEOkwAXhusD912Opy5mT3S5xrh8z/DvB52+ETUc+dpQhtCRpGlSY3hoSKS/d7ov+A=
ARC-Message-Signature:i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1757080747; c=relaxed/simple;
	bh=d79gF3C/4tQwTaSFPW6C3OwVcb/ZdZ9Ef2lR8kqdQ7o=;
	h=From:Date:Subject:MIME-Version:Content-Type:Message-Id:References:
	 In-Reply-To:To:Cc; b=spKD/l9DJmgkNWgoPkVhlAW70xzK3wucFFeOelLHM7jkxRVcEdklLN2fc/T8iOwzXb1OPzyX8m7NAU5LtNpOwkwjueZ5t7l6yi6L0NDQvtAc4caPXVhdvnhJZqeaiJm2jBw1HYX1njvQWtPwTYO7iNSq8+ZYuDCpzkwRe0Rbx6Q=
ARC-Authentication-Results:i=1; smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=ideasonboard.com; spf=pass smtp.mailfrom=ideasonboard.com; dkim=pass (1024-bit key) header.d=ideasonboard.com header.i=@ideasonboard.com header.b=pOBn7PW1; arc=none smtp.client-ip=213.167.242.64
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=none dis=none) header.from=ideasonboard.com
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=ideasonboard.com
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (1024-bit key) header.d=ideasonboard.com header.i=@ideasonboard.com header.b="pOBn7PW1"
Received: from [127.0.1.1] (91-158-153-178.elisa-laajakaista.fi [91.158.153.178])
	by perceval.ideasonboard.com (Postfix) with ESMTPSA id 0C5E11129;
	Fri,  5 Sep 2025 15:57:50 +0200 (CEST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=ideasonboard.com;
	s=mail; t=1757080670;
	bh=d79gF3C/4tQwTaSFPW6C3OwVcb/ZdZ9Ef2lR8kqdQ7o=;
	h=From:Date:Subject:References:In-Reply-To:To:Cc:From;
	b=pOBn7PW1/oGYZdn8RIS3t36exOo+3miQO57jAs4BNjwkNJsBbxlmKAYnaBkBCtoKw
	 s4Pp2eItNha/SYLNB0HZCU5whzGUHZyveZxQ2WzgmVujU8jbmGPb2Ebs3jaYFA8Zqp
	 ej6868HnB+xuX8KJ3HzHHhUNWjwV4+RxkWaiabYY=
From: Tomi Valkeinen <tomi.valkeinen@ideasonboard.com>
Date: Fri, 05 Sep 2025 16:58:07 +0300
Subject: [PATCH 2/2] drm/tidss: Set vblank (event) time at
 crtc_atomic_enable
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: 7bit
Message-Id: <20250905-tidss-fix-timestamp-v1-2-c2aedf31e2c9@ideasonboard.com>
References: <20250905-tidss-fix-timestamp-v1-0-c2aedf31e2c9@ideasonboard.com>
In-Reply-To: <20250905-tidss-fix-timestamp-v1-0-c2aedf31e2c9@ideasonboard.com>
To: Jyri Sarha <jyri.sarha@iki.fi>, 
 Maarten Lankhorst <maarten.lankhorst@linux.intel.com>, 
 Maxime Ripard <mripard@kernel.org>, Thomas Zimmermann <tzimmermann@suse.de>, 
 David Airlie <airlied@gmail.com>, Simona Vetter <simona@ffwll.ch>
Cc: Pekka Paalanen <pekka.paalanen@collabora.com>, 
 dri-devel@lists.freedesktop.org, linux-kernel@vger.kernel.org, 
 Laurent Pinchart <laurent.pinchart@ideasonboard.com>, 
 Tomi Valkeinen <tomi.valkeinen@ideasonboard.com>
X-Mailer: b4 0.15-dev-c25d1
X-Developer-Signature: v=1; a=openpgp-sha256; l=2935;
 i=tomi.valkeinen@ideasonboard.com; h=from:subject:message-id;
 bh=d79gF3C/4tQwTaSFPW6C3OwVcb/ZdZ9Ef2lR8kqdQ7o=;
 b=kA0DAAgB+j2qjLyWHvUByyZiAGi67KGgJvXjBdQxQKSKuxn8T0Yg595MYXVGDJ8y3/JBORSeI
 4kCMwQAAQgAHRYhBMQ4DD6WXv2BB5/zp/o9qoy8lh71BQJouuyhAAoJEPo9qoy8lh71/LAP/jeQ
 GWd3PwHtj5TKTlhMcI2GexXtRc97s9LF6bLB7PJqmytjuEeLzFnNrlMmDR71+3AtIwWej3HGxBr
 llceGPDJfXPqaNsI/TX8EpHkaBlvW1lG2nuDp8Me5dDE7Eb4fDADDfUv0hvHwnfNoc8UBd24llv
 K1oasihGfVPjk/i08frrYVFTczGixaTNtBTqEma280IEf3UTTqwssQoT6or7nFE4pGOyIrBoaT7
 wmmXczGLlvAbFMwXwlk9fcyvib2zj8fO8GGiMzunCEAiuuA3AJUTE9aLV+3j97lnQcRpFxgzbqk
 gfinKzBZetSRBNIJYi7gh0krd9w05/sJZUoVyKQvPBpqq2zLPWD+i+n0wAUyrk9ugedCRYwKTj3
 WXaFcPazsXGgguCvNfTfq1S2H+WDWzoHdC8KDoXBNtsJoYKfof11bQstKYHM3rGbnlWZRoPDSq/
 yihELyH8yqJsSlmpXjpsA2RaIu7zNS481CZw/4uhXpjpYvf/geca1OW3YIE9ZJ2k3syKok1fZQ5
 lKHWOl/Rh3pj4pBGPNuuON+gNC9RVoVpYg2aTTxqT4O7OMbE8lnFgdhamviK8Zd4BvzZ51kjBEP
 eKEnaa6hj16L4jRO11rYRzJarPJgpShOyTMBe59hoZPBQBLt1RDE5J/LWeyxTyvS3/S9DVrHxVh
 TAH91
X-Developer-Key: i=tomi.valkeinen@ideasonboard.com; a=openpgp;
 fpr=C4380C3E965EFD81079FF3A7FA3DAA8CBC961EF5

It was reported that Weston stops at an assert, which checks that the
page flip event timestamp is the same or newer than the previous
timestamp:

weston_output_finish_frame: Assertion `timespec_sub_to_nsec(stamp, &output->frame_time) >= 0' failed.

With manual tests, I can see that when I enable the CRTC, I get a page
flip event with a timestamp of 0. Tracking this down led to
drm_reset_vblank_timestamp() which does "t_vblank = 0" if
"high-precision query" is not available.

TI DSS does not have any hardware timestamping, and thus the default
ktime_get() is used in the DRM framework to get the vblank timestamp,
and ktime_get() is not "high precision" here.

It is not quite clear why the framework behaves this way, but I assume
the idea is that drm_crtc_vblank_on(), which calls
drm_reset_vblank_timestamp(), can be called at any time, and thus
ktime_get() wouldn't give a good timestamp. And, the idea is that the
driver would wait until next vblank after the CRTC enable, and then we
could get a good timestamp. This is hinted in the comment: "reinitialize
delayed at next vblank interrupt and assign 0 for now".

I think that makes sense. However, when we enable the CRTC in TI DSS,
i.e. we write the enable bit to the hardware, that's the exact moment
when the "vblank cycle" starts. It is the zero point in the cycle, and
thus ktime_get() would give a good timestamp.

I am not sure if this is applicable to other hardware, and if so, how
should it be solved in the framework. So, let's fix this in the tidss
driver at least for now.

This patch updates the vblank->time manually to ktime_get() just before
sending the vblank event, and we enable the crtc just before calling
ktime_get(). To get even more exact timing, the dispc_vp_enable() is
moved inside the event_lock spinlock.

With this, we get a proper timestamp for the page flip event from
enabling the CRTC, and Weston is happy.

Signed-off-by: Tomi Valkeinen <tomi.valkeinen@ideasonboard.com>
---
 drivers/gpu/drm/tidss/tidss_crtc.c | 9 +++++++--
 1 file changed, 7 insertions(+), 2 deletions(-)

diff --git a/drivers/gpu/drm/tidss/tidss_crtc.c b/drivers/gpu/drm/tidss/tidss_crtc.c
index 1b767af8e1f6..6898f12bb364 100644
--- a/drivers/gpu/drm/tidss/tidss_crtc.c
+++ b/drivers/gpu/drm/tidss/tidss_crtc.c
@@ -244,11 +244,16 @@ static void tidss_crtc_atomic_enable(struct drm_crtc *crtc,
 
 	dispc_vp_prepare(tidss->dispc, tcrtc->hw_videoport, crtc->state);
 
-	dispc_vp_enable(tidss->dispc, tcrtc->hw_videoport);
-
 	spin_lock_irqsave(&ddev->event_lock, flags);
 
+	dispc_vp_enable(tidss->dispc, tcrtc->hw_videoport);
+
 	if (crtc->state->event) {
+		unsigned int pipe = drm_crtc_index(crtc);
+		struct drm_vblank_crtc *vblank = &ddev->vblank[pipe];
+
+		vblank->time = ktime_get();
+
 		drm_crtc_send_vblank_event(crtc, crtc->state->event);
 		crtc->state->event = NULL;
 	}

-- 
2.43.0


